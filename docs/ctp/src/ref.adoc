
== Reference Model

Certification relies on a reference model (simulator) to compute the expected results of a test, such as sum of two numbers in an `add` instruction or the answer for a `fsqrt.d` instruction.  Self-checking tests compare the result from the DUT against the expected result that was precomputed by the reference model and flag mismatches.

RISC-V International has blessed https://github.com/riscv/sail-riscv[Sail] as the golden RISC-V model, so Sail is used as the reference model.

=== Deterministic, Nondeterministic, and Unspecified Behaviors

RISC-V feature behavior can be classified as deterministic, nondeterministic, and unspecified.  Determinstic features have a unique expected value for a given configuration, such as the result of `sub` 1 - 2 on RV32.  Nondetermistic features have a fine set of possible outcomes, and might vary unpredictably even on the same DUT.  For example, vector tail-agnostic elements can preserve the input value or propagate all 1s, with no guarantee whether the same instruction has the same behavior on all elements or when executed twice in a row. Unspecifed features, such as unimplemented instructions, could do anything, from being ignored, to preditably or unpredictably changing architectural state, to halting and catching fire.

All RISC-V simulators, when properly configured to match the behavior of a DUT, should produce the same answers as the DUT and each other for deterministic features.  For nondeterministic features, they should produce one of the legal outcomes.  For unspecified features, they can do anthing.

Self-checking certification tests must check that the resut of deterministic features match the reference model.  Nondeterministic features must produce one of the finite set of legal outcomes, which must be provided by the test developer because a reference model only produces a single outcome.  Unspecified features are not tested because there are no wrong answers.

This is harder than it seems because RISC-V has many features whose behaviors are not fully specified.  Many of these features are not yet named, and the set of legal behaviors is not yet enumerated.  https://github.com/riscv-software-src/riscv-unified-db[Unified Database] (UDB) is in the process of naming and enumerating all of these features and behaviors to fully describe the behavior of a DUT.  Moreover, no simulator yet is fully configurable to match every feature.  Some simulators, such as Spike, intentionally have a minimal set of configuration options and are hardwired to particular behaviors.

Nevertheless, Sail is making rapid progress and is aiming to fully implement the ratified RVA23 profile, read a UDB configruation, and support at least the most reasonable behaviors in time for certification.

=== Test Qualification

For each supported profile, the certification tests will be qualified on at least one DUT configuration.  This configuration should be one supported by Spike and as many other simulators as possible.  Qualification involves running the same compiled tests on many RISC-V simulators and having them all pass.  Preferred simulators include:

* Sail (required, golden reference)
* Spike
* ImperasFPM (license required)
* QEMU
* Whisper
* IDL (if available)

The configuration includes

* Memory map and linker with main memory starting at 0x80000000
* Reset vector at 0x80000000, or at 0x1000 with a jump to 0x80000000 before any tests are run
* Trick box including:
** CLINT configured at 0x***
** *** TBD how to trigger external interrupts & HGEI
** RVMODEL_HALT using HTIF write_tohost followed by a infinite loop jump to self
** Empty RVMODEL_BOOT macro (no boot code required)

*** will describe such UDB configurations for each certification profile.

Tests can receive a qualification waiver if they fail in certain simulators for the following reasons:

* The simulator does not yet support the relevant extension
* The simulator has a known bug with an issue filed
* The simulator cannot be configured for a feature in a way compatible with the set of configurations supported by Sail and Spike

=== List of Fundamentally Nondeterministic Behaviors

* Mask- and tail-agnostic vector operations
** Self-checking tests must accept undisturbed and all 1s in each element
* Traps on misaligned accesses
** If mtval is written with a nonzero value, it can be any address within the access***
** When it also causes access fault, Allen has list of 7ish possible outcomes.

*** need to identify all coverpoints whose behavior is nondetermistic, and list all acceptable test outcomes as part of the test spec.

=== List of Theoretically Nondeterministic Behaviors with Configurable Deterministic Implementations

* CSR WARL Fields: any legal value could be read, and the value is theoretically nondeterministic and could change from one write to another.  UDB will define configurations with a single sensible behavior (such as all 0s), and we may limit certification to DUTs that implement a reasonable configuration.
